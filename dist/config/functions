# CUSTOM FUNCTIONS

# function: wf_tmuxxx
wf_tmuxxx () {
    # If no argument is passed, print the help message
    if [ -z "$1" ]; then
        echo "Usage: wf_tmuxxx <session-name>";
        echo "Sessions: cer,home";
        return;
    fi

    # Check $1 is a valid session name
    if [ "$1" != "cer" ] && [ "$1" != "home" ]; then
        echo "Invalid session name";
        echo "Sessions: cer,home";
        return;
    fi

    # Start the tmux session
    tmux -f "$HOME/.tmux/tmux.conf" start-server \; source-file "$HOME/.tmux/$1"
    tmux attach-session -t $1
}

# function: wf_github_clone_user_repositories
wf_github_clone_user_repositories() {
    echo -n "[*] Enter GitHub user/org name: "
    read -r TARGET

    JSON_FIELDS="name,sshUrl"
    REPO_METADATA=$(gh repo list "$TARGET" -L 100 --no-archived --json "$JSON_FIELDS")

    REPO_DIR="/home/$USER/repos/$TARGET"
    mkdir -p "$REPO_DIR"
    cd "$REPO_DIR" || exit 1

    # Loop array of repo SSH URLs and clone
    jq -c '.[]' <<< "$REPO_METADATA" | while read -r JSON; do
        name=$(jq -c '.name' <<< "$JSON"  | tr -d '"')
        sshUrl=$(jq -c '.sshUrl' <<< "$JSON"  | tr -d '"')

        echo "[*] Processing: $name"

        # Check if folder already exists
        if [ ! -d "$REPO_DIR/$name" ]; then
            echo "[*] Cloning: $sshUrl"
            git clone "$sshUrl"
        fi
    done
}

# function: wf_github_disable_project_for_user
wf_github_disable_project_for_user() {
    echo -n "[*] Enter GitHub user/org name: "
    read -r TARGET

    JSON_FIELDS="nameWithOwner,hasProjectsEnabled"
    REPO_METADATA=$(gh repo list "$TARGET" -L 100 --no-archived --json $JSON_FIELDS)

    # Loop repos, check for enabled project and disable the project
    jq -c '.[]' <<< "$REPO_METADATA" | while read -r JSON; do
        hasProjectsEnabled=$(jq -c '.hasProjectsEnabled | tostring' <<< "$JSON"  | tr -d '"')
        nameWithOwner=$(jq -c '.nameWithOwner' <<< "$JSON"  | tr -d '"')
        echo "[*] $nameWithOwner | $hasProjectsEnabled"

        # Disable the repository wiki if it is enabled
        if [ "$hasProjectsEnabled" = "true" ]; then
            echo "[*] Disabling repository project..."
            gh repo edit "$nameWithOwner" --enable-projects=false
        fi

    done
}

# function: wf_github_disable_wiki_for_user
wf_github_disable_wiki_for_user() {
    echo -n "[*] Enter GitHub user/org name: "
    read -r TARGET

    JSON_FIELDS="nameWithOwner,hasWikiEnabled"
    REPO_METADATA=$(gh repo list "$TARGET" -L 100 --no-archived --json $JSON_FIELDS)

    # Loop repos, check for enabled wiki and disable the wiki
    jq -c '.[]' <<< "$REPO_METADATA" | while read -r JSON; do
        hasWikiEnabled=$(jq -c '.hasWikiEnabled | tostring' <<< "$JSON"  | tr -d '"')
        nameWithOwner=$(jq -c '.nameWithOwner' <<< "$JSON"  | tr -d '"')
        echo "[*] $nameWithOwner | $hasWikiEnabled"

        # Disable the repository wiki if it is enabled
        if [ "$hasWikiEnabled" = "true" ]; then
            echo "[*] Disabling repository wiki..."
            gh repo edit "$nameWithOwner" --enable-wiki=false
        fi
    done
}

# function: wf_sshfs_mount
wf_sshfs_mount() {
    # Get list of Host entries and prompt user to select one
    HOSTS=$(grep -E '^Host\s+' "$CONFIG" | grep -v '*' | awk '{print $2}')
    echo "Available SSH Hosts:"
    select HOST in $HOSTS; do
        if [ -n "$HOST" ]; then
            break
        fi
    done

    # Extract details from config
    HOSTNAME=$(awk "/Host $HOST/{f=1} f && /HostName/{print \$2; exit}" "$CONFIG")
    PORT=$(awk "/Host $HOST/{f=1} f && /Port/{print \$2; exit}" "$CONFIG")
    USER=$(awk "/Host $HOST/{f=1} f && /User/{print \$2; exit}" "$CONFIG")
    echo "[*] HostName: $HOSTNAME"
    echo "[*] Port: ${PORT}"
    echo "[*] User: ${USER}"

    # Set mount point, and create if it doesn't exist
    LOCAL_MOUNT_POINT="$HOME/sshfs"
    if [ ! -d "$LOCAL_MOUNT_POINT" ]; then
        mkdir -p "$LOCAL_MOUNT_POINT"
    fi

    # Mount using sshfs
    sshfs "$HOST":"/home/$USER" "$LOCAL_MOUNT_POINT" 
}

# function: wf_sshfs_umount
wf_sshfs_umount() {
    LOCAL_MOUNT_POINT="$HOME/sshfs"
    umount "$LOCAL_MOUNT_POINT"
}

# function: wf_ramdisk
wf_ramdisk () {
    ramdisk_path="$HOME/ramdisk"
    if [ ! -d "$ramdisk_path" ]; then
        echo "Creating RAM disk directory..."
        mkdir $ramdisk_path
    fi
    if [[ "$1" = "mount" ]]; then
        echo "Mounting RAM disk..."
        sudo mount -t tmpfs -o size=2048M tmpfs $ramdisk_path
    elif [[ "$1" = "umount" ]]; then
        echo "Unmounting RAM disk..."
        sudo umount $ramdisk_path
    else
        echo "Usage:"
        echo "ramdisk mount -- mounts RAM disk"
        echo "ramdisk umount -- unmounts RAM disk"
    fi
}

# function: wf_transmission_bind
wf_transmission_bind () {
    # Kill transmission-daemon if it is running
    transmission_da_pids=$(pgrep transmission-da)
    if [ "$transmission_da_pids" ]; then
        echo "Killing transmission-daemon processes..."
        sudo pkill transmission-da
    fi

    # Get VPN IP to bind to
    # bind_address=$(ip -br addr show moz0 | awk '{print $3}')
    bind_address=$(curl http://ipecho.net/plain; echo)

    # If IP wasn't found then quit
    if [ -z $bind_address ]; then
        echo "VPN doesn't seem to be up. Will not start transmission-daemon"
        exit 1
    fi

    # Start transmission-daemon
    transmission-daemon --rpc-bind-address=127.0.0.1 --bind-address-ipv4=$bind_address
    echo "transmission-daemon started and bound to address $bind_address"
}
